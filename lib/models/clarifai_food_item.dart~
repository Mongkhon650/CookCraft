import 'package:http/http.dart' as http;
import 'dart:convert';
import '../utils/json_food_loader.dart'; // นำเข้า JsonLoader

class FoodItemRecognition {
  static const String _apiKey = 'ffdd303949ff4cce9b135afd01ee3b82'; // ใส่ API Key ของคุณ
  static const String _url = 'https://api.clarifai.com/v2/models/food-item-recognition/outputs';

  // ฟังก์ชันใหม่: รองรับหลายภาพ
  static Future<List<Map<String, dynamic>>> analyzeImages(List<String> base64Images) async {
    try {
      final translations = await JsonLoader.loadTranslations();

      // สร้าง JSON Payload สำหรับภาพหลายภาพ
      final inputs = base64Images.map((base64Image) {
        return {
          "data": {
            "image": {"base64": base64Image},
          },
        };
      }).toList();

      final response = await http.post(
        Uri.parse(_url),
        headers: {
          'Authorization': 'Key $_apiKey',
          'Content-Type': 'application/json',
        },
        body: jsonEncode({"inputs": inputs}),
      );

      if (response.statusCode == 200) {
        final data = jsonDecode(response.body);

        List<Map<String, dynamic>> results = [];
        for (var output in data['outputs']) {
          final concepts = output['data']['concepts'];
          for (var c in concepts) {
            final name = c['name'];
            print('Name: ${c['name']}, Confidence: ${(c['value'] * 100).toStringAsFixed(2)}');
            final translatedName = translations[name] ?? name;
            results.add({
              'name': translatedName,
              'confidence': (c['value'] * 100).toStringAsFixed(2),
            });
          }
        }
        return results;
      } else {
        throw Exception('Failed to analyze images: ${response.body}');
      }
    } catch (e) {
      print('Error: $e');
      return [];
    }
  }
}

